# 自定义网络

---

## 1.创建网络模板

在TripleO的默认部署中，所有的网络流量都走Provisioning Network。那能不能把每种类型的网络分离出来？当然可以！

TripleO网络中有以下网络类型:

```
Network 1 - Provisioning
Network 2 - Internal API
Network 3 - Tenant Networks
Network 4 - Storage
Network 5 - Storage Management
Network 7 - External and Floating IP (mapped after Overcloud creation)
```

假设我们有如下网络,应该如何写网络配置文件。

| 网络类型 | Subnet | VLAN |
| :--- | :--- | :--- |
| PXE/SSH | 192.0.2.0/24 | access |
| Internal API | 172.16.0.0/24 | 201 |
| Tenant | 172.17.0.0/24 | 202 |
| Storage | 172.18.0.0/24 | 203 |
| Storage Management | 172.19.0.0/24 | 204 |
| External / Floating IP | 192.168.122.0/24 | 205 |

从``


## 2. 分配主机IP

在使用isolation network部署overcloud时，所有的isolation netwrok IP 都会从`network-environment.yaml`定义的pool中获取。在部署生产环境时，一定不想让IP失控：每台节点都随机的从IP pool里随机挑选IP会让排错异常困难。因为你不知道哪个节点用哪个IP。

**network-environment.yaml 节选**

```yaml
parameter_defaults:
  InternalApiAllocationPools: [{'start': '172.16.0.10', 'end': '172.16.0.200'}]
  TenantAllocationPools: [{'start': '172.17.0.10', 'end': '172.17.0.200'}]
  StorageAllocationPools: [{'start': '172.18.0.10', 'end': '172.18.0.200'}]
  StorageMgmtAllocationPools: [{'start': '172.19.0.10', 'end': '172.19.0.200'}]
  # Leave room for floating IPs in the External allocation pool
  ExternalAllocationPools: [{'start': '192.168.122.10', 'end': '192.168.122.200'}]
```

## 2. 部署代码自定义

## 3.



**Vip registry**
```
resource_registry:
  OS::TripleO::Network::Ports::NetVipMap: /usr/share/openstack-tripleo-heat-templates/network/ports/net_vip_map_external.yaml
  OS::TripleO::Network::Ports::ExternalVipPort: /usr/share/openstack-tripleo-heat-templates/network/ports/noop.yaml
  OS::TripleO::Network::Ports::InternalApiVipPort: /usr/share/openstack-tripleo-heat-templates/network/ports/noop.yaml
  OS::TripleO::Network::Ports::StorageVipPort: /usr/share/openstack-tripleo-heat-templates/network/ports/noop.yaml
  OS::TripleO::Network::Ports::StorageMgmtVipPort: /usr/share/openstack-tripleo-heat-templates/network/ports/noop.yaml
  OS::TripleO::Network::Ports::RedisVipPort: /usr/share/openstack-tripleo-heat-templates/network/ports/from_service.yaml
```

**Vip parameter**
```
parameter_defaults:
  ...
  # Predictable VIPs
  ControlPlaneIP: 192.168.0.230
  ExternalNetworkVip: 10.1.1.190
  InternalApiNetworkVip: 172.16.0.30
  StorageNetworkVip: 172.18.0.30
  StorageMgmtNetworkVip: 172.19.0.40
  ServiceVips:
    redis: 172.16.0.31
```
