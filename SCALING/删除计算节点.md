# 节点伸缩

---

## 支持收缩或者扩展的节点类型

| 节点类型 | 扩展? | 收缩? | 备注 |
| :--- | :--- | --- | --- |
| Controller | N | N | 一旦部署完成，控制节点不支持收缩或者扩展。 |
| Compute | Y | Y | |
| Ceph Storage Nodes | Y | N | 在部署时至少有一个ceph节点时，才支持扩展。 |
| Block Storage Nodes | N | N | 一旦部署完成，Cinder节点不支持收缩或者扩展。 |
| Object Storage Nodes | Y | Y | |

## 增加计算节点

在增加节点的时候，我们需要收集每一个新增节点的PXE网卡的MAC地址,然后定义我们的ironic的配置文件

```
{
"nodes": [
    {
      "pm_user": "root",
      "arch": "x86_64",
      "name": "10.0.10.126_compute",
      "pm_addr": "10.0.10.126",
      "pm_password": "XXXX",
      "pm_type": "pxe_ipmitool",
      "mac": [
        "24:6E:96:06:2E:04"
      ],
      "cpu": "32",
      "memory": "8192",
      "disk": "599"
    }
]
```

然后我们需要在ironic中注册这个物理机:
```
$ openstack baremetal import newnode.json
```
然后开始收集这台物理机的硬件信息:
```
$ openstack baremetal node manage <NODE UUID>
$ openstack overcloud node introspect <NODE UUID> --provide
```

然后定义物理机的角色:
```
openstack baremetal node set --property capabilities='profile:compute,boot_option:local' <NODE UUID>
```
之后就开始拓展新增节点:
```
$ openstack overcloud deploy --templates --compute-scale 5
[OTHER_OPTIONS]
```
拓展节点的时候记得要加上你的其他的环境参数，如果缺了哪一个环境参数你的环境就很有可能被修改。


## 删除计算节点

1. 删除计算节点前，先把VM从当前计算节点前迁移出去
2. 在overcloud中，禁用nova service。
3. 在 undercloud中，查询stack 名称
```
$ heat stack-list
```
4. 在undercloud中，查询要删除的nova compute 节点的UUID
```
openstack overcloud node delete --stack [STACK_UUID] --templates \
-e [ENVIRONMENT_FILE] [NODE1_UUID] [NODE2_UUID] [NODE3_UUID]
```
> 在删除节点时需要使用和部署时一样的environment参数(e.g. -e 或者 --environment-file)。不需要其他的参数。

5. 在删除nova-service
```
$ source ~/stack/overcloudrc
$ nova service-delete [service-id]
$ source ~/stack/stackrc
```
6. 删除nuetro agent
```
$ source ~/stack/overcloudrc
$ neutron agent-list
$ neutron agent-delete [openvswitch-service-id]
$ source ~/stack/stackrc
```

## 参考
https://access.redhat.com/documentation/en/red-hat-openstack-platform/10/paged/director-installation-and-usage/chapter-8-scaling-the-overcloud